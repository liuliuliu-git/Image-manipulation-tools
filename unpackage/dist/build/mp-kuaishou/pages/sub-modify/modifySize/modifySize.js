(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/sub-modify/modifySize/modifySize"],{3889:function(t,e,i){"use strict";i.d(e,"b",(function(){return n})),i.d(e,"c",(function(){return s})),i.d(e,"a",(function(){return r}));var r={uButton:function(){return Promise.all([i.e("common/vendor"),i.e("uni_modules/uview-ui/components/u-button/u-button")]).then(i.bind(null,"eca6"))},sizeSpecification:function(){return i.e("components/sizeSpecification/sizeSpecification").then(i.bind(null,"56bb"))},uOverlay:function(){return Promise.all([i.e("common/vendor"),i.e("uni_modules/uview-ui/components/u-overlay/u-overlay")]).then(i.bind(null,"4623"))},uForm:function(){return Promise.all([i.e("common/vendor"),i.e("uni_modules/uview-ui/components/u-form/u-form")]).then(i.bind(null,"5458"))},uFormItem:function(){return Promise.all([i.e("common/vendor"),i.e("uni_modules/uview-ui/components/u-form-item/u-form-item")]).then(i.bind(null,"cfe6"))},"u-Input":function(){return Promise.all([i.e("common/vendor"),i.e("uni_modules/uview-ui/components/u--input/u--input")]).then(i.bind(null,"0a14"))}},n=function(){var t=this.$createElement;this._self._c},s=[]},"5f92":function(t,e,i){"use strict";i.r(e);var r=i("c2ea"),n=i.n(r);for(var s in r)["default"].indexOf(s)<0&&function(t){i.d(e,t,(function(){return r[t]}))}(s);e["default"]=n.a},"849a":function(t,e,i){"use strict";i.r(e);var r=i("3889"),n=i("5f92");for(var s in n)["default"].indexOf(s)<0&&function(t){i.d(e,t,(function(){return n[t]}))}(s);i("c6ea");var o=i("828b"),h=Object(o["a"])(n["default"],r["b"],r["c"],!1,null,"73110b1a",null,!1,r["a"],void 0);e["default"]=h.exports},"8b7d":function(t,e,i){},c2ea:function(t,e,i){"use strict";(function(t){var r=i("47a9");Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var n=r(i("7eb4")),s=r(i("7ca3")),o=r(i("af34")),h=r(i("ee10")),c=i("f0fc"),a=(r(i("9171")),i("c7a2"),r(i("4ba7")));function u(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,r)}return i}function g(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?u(Object(i),!0).forEach((function(e){(0,s.default)(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):u(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}var m={data:function(){return{defineIndex:0,ctx:null,imgUrl:"",clipUrl:"",result:"",dpi:150,sizeArr:[],content:"观看广告，解锁功能",setShow:!1,isClick:!1,cropWidth:150,cropHeight:150,form:{width:295,height:413,dpi:150},fileType:"jpg",formatNew:1,startX:0,startY:0,rules:{"form.width":{type:"string",trigger:["blur","change"]},"form.height":{type:"string",trigger:["blur","change"]},"form.dpi":{type:"string",trigger:["blur","change"]}},imgWidth:250,imgHeight:250,screenWidth:0,screenHeight:400,imgX:0,imgY:0,isMoving:!1,currentNumber:1,cropX:0,cropY:0,rewardAd:null}},components:{banner:function(){i.e("components/banner/index").then(function(){return resolve(i("bbcf"))}.bind(null,i)).catch(i.oe)},sizeSpecification:function(){i.e("components/sizeSpecification/sizeSpecification").then(function(){return resolve(i("56bb"))}.bind(null,i)).catch(i.oe)}},onReady:function(t){this.initCanvas(),this.drawImage(this.imgUrl),this.setBgBox()},onLoad:function(t){var e=this;return(0,h.default)(n.default.mark((function i(){var r,s,h,c;return n.default.wrap((function(i){while(1)switch(i.prev=i.next){case 0:return e.form.width=JSON.parse(t.sizeList).widthpx,e.form.height=JSON.parse(t.sizeList).heightpx,e.form.dpi=JSON.parse(t.sizeList).dpi,e.rewardAd=new a.default(e.getJli,e.customRewardUser),e.imgUrl=t.imgUrl,i.next=7,e.getDataApi();case 7:for(r=JSON.parse(t.sizeList),"点击自定义"==r.imageName&&(e.setShow=!0),s={imageName:"点击自定义",widthpx:e.form.width,heightpx:e.form.height,width:"",height:""},e.sizeArr.unshift(s),e.sizeArr.unshift(JSON.parse(t.sizeList)),h=new Map,c=0;c<e.sizeArr.length;c++)"点击自定义"==e.sizeArr[0].imageName?e.defineIndex=0:e.defineIndex=1,e.sizeArr[c].isChecked=!1,h.has(e.sizeArr[c].imageName)||h.set(e.sizeArr[c].imageName,e.sizeArr[c]);e.sizeArr=(0,o.default)(h.values()),e.$set(e.sizeArr,0,g(g({},e.sizeArr[0]),{},{isChecked:!0}));case 16:case"end":return i.stop()}}),i)})))()},computed:{getId:function(){return this.$store.state.bannerId?this.$store.state.bannerId:""},getJli:function(){return this.$store.state.jLiId?this.$store.state.jLiId:""}},methods:{handleCrop:function(t,e){e>=this.imgHeight&&t>=this.imgWidth?(this.cropHeight=this.imgHeight,this.cropWidth=this.imgWidth):e>=this.imgHeight?(this.cropHeight=this.imgHeight,this.cropWidth=t):t>=this.imgWidth?(this.cropHeight=e,this.cropWidth=this.imgWidth):(this.cropHeight=e,this.cropWidth=t)},initCanvas:function(){this.ctx=t.createCanvasContext("myCanvas")},toChooseSize:function(){t.navigateTo({url:"/pages/sub-modify/chooseSize/chooseSize"})},replace:function(){var e=this;t.chooseImage({count:1,sizeType:["original","compressed"],sourceType:["album"],success:function(t){t.tempFilePaths[0];e.imgUrl=t.tempFilePaths[0],e.currentNumber=1,e.drawImage(e.imgUrl),e.setBgBox()}})},magnify:function(){this.currentNumber<=1.4?this.currentNumber+=.05:this.currentNumber=1,this.ctx.drawImage(this.imgUrl,this.imgX,this.imgY,this.imgWidth*this.currentNumber,this.imgHeight*this.currentNumber),this.ctx.draw(),this.setBgBox()},shrink:function(){this.currentNumber>=.7?this.currentNumber-=.05:this.currentNumber=1,this.ctx.drawImage(this.imgUrl,this.imgX,this.imgY,this.imgWidth*this.currentNumber,this.imgHeight*this.currentNumber),this.ctx.draw(),this.setBgBox()},set:function(){this.setShow=!0},clipImage:function(){var e=this;t.showModal({title:"修改尺寸",content:"观看广告，解锁修改尺寸功能",success:function(t){t.confirm&&e.rewardAd.init()},fail:function(t){console.log(t)}})},clipSize:function(){var t=this;return(0,h.default)(n.default.mark((function e(){return n.default.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,t.clipImage();case 2:case"end":return e.stop()}}),e)})))()},customRewardUser:function(){var e=this;return new Promise((function(i,r){t.showLoading({title:"保存中"}),t.canvasToTempFilePath({canvasId:"myCanvas",x:e.cropX,y:e.cropY,width:e.cropWidth,height:e.cropHeight,fileType:e.fileType,success:function(r){t.showLoading({title:"上传中"}),t.uploadFile({url:e.$store.state.baseUrl+"/ms111/compress/ms111/postImage",filePath:r.tempFilePath,name:"multipartFiles",formData:{height:e.imgHeight,width:e.imgWidth},success:function(t){e.clipUrl=JSON.parse(t.data).msg,e.putSizeApi(JSON.stringify({dpi:e.form.dpi,format:e.formatNew,heightpx:e.form.height,imagePath:e.clipUrl,widthpx:e.form.width})),i()},fail:function(t){console.log(t)}})},fail:function(t){console.error(t)},complete:function(){t.hideLoading()}})}))},jpgClick:function(){this.isClick=!1,this.fileType="jpg",this.formatNew=1},pngClick:function(){this.isClick=!0,this.fileType="png",this.formatNew=2},getDataApi:function(){var t=this;return new Promise((function(e,i){(0,c.getData)({isHot:1}).then((function(i){t.sizeArr=i.data.map((function(t){return g(g({},t),{},{isChecked:!1})})),e()})).catch((function(t){i(t)}))}))},changeChecked:function(t,e){"点击自定义"==t.imageName?(this.setShow=!0,this.form.width="",this.form.height="",this.form.dpi=""):(this.form.width=t.widthpx,this.form.height=t.heightpx,this.form.dpi=t.dpi);for(var i=0;i<this.sizeArr.length;i++)this.$set(this.sizeArr,i,g(g({},this.sizeArr[i]),{},{isChecked:!1}));this.handleCrop(t.widthpx,t.heightpx),this.setBgBox(),this.$set(this.sizeArr,e,g(g({},this.sizeArr[e]),{},{isChecked:!0}))},cancel:function(){this.setShow=!1},submit:function(){var e=this,i=this.form.width,r=this.form.height,n=this.form.dpi;if(""==i||""==r||""==n)t.showToast({title:"请输入正确值",icon:"error",duration:2e3});else{var s=/^\d+$/;s.test(i)&&s.test(r)&&s.test(n)?(this.setShow=!1,this.$refs.uForm.validate().then((function(t){console.log("验证通过"),e.handleCrop(Number(e.form.width),Number(e.form.height)),e.setBgBox();for(var i=0;i<e.sizeArr.length;i++)i==e.defineIndex?(e.sizeArr.splice(e.defineIndex,1,{imageName:"点击自定义",widthpx:Number(e.form.width),heightpx:Number(e.form.height),width:"",height:""}),e.$set(e.sizeArr,e.defineIndex,g(g({},e.sizeArr[e.defineIndex]),{},{isChecked:!0}))):e.$set(e.sizeArr,i,g(g({},e.sizeArr[i]),{},{isChecked:!1}))})).catch((function(t){console.log("验证失败")}))):t.showToast({title:"请只输入数字",icon:"error",duration:2e3})}},putSizeApi:function(e){var i=this;(0,c.putSize)(e).then((function(e){i.result=e.data,t.downloadFile({url:i.$store.state.baseUrl+i.result,success:function(t){var e=t.tempFilePath;200==t.statusCode&&i.getSet(e,i.result)},fail:function(t){console.log(t)}})})).catch((function(t){console.log(t)}))},deleteImageApi:function(t){(0,c.deleteImage)(t).then((function(t){})).catch((function(t){console.log(t,111)}))},saveImage:function(e,i){var r=this;t.saveImageToPhotosAlbum({filePath:e,success:function(e){r.deleteImageApi(i),t.hideLoading()},fail:function(e){return console.log(e.errMsg),t.showToast({title:"请重新保存",icon:"error",duration:2e3})},complete:function(e){t.hideLoading()}})},getSet:function(e,i){var r=this;t.getSetting({success:function(n){n.authSetting["scope.writePhotosAlbum"]?r.saveImage(e,i):t.authorize({scope:"scope.writePhotosAlbum",success:function(){t.showToast({title:"保存成功！"}),r.saveImage(e,i)},fail:function(){t.hideLoading(),t.showModal({title:"您已拒绝获取相册权限",content:"是否进入权限管理，调整授权？",success:function(e){if(e.confirm)t.openSetting({success:function(t){console.log(t.authSetting)}});else if(e.cancel)return t.showToast({title:"已取消！",icon:"error",duration:2e3})}})}})},fail:function(t){console.log(t)}})},setBgBox:function(){var e=this;t.getSystemInfo({success:function(i){e.screenWidth=i.windowWidth;var r=t.createCanvasContext("firstCanvas");e.handleCrop(e.cropWidth,e.cropHeight),e.cropX=(e.screenWidth-e.cropWidth)/2,e.cropY=(e.screenHeight-e.cropHeight)/2,r.clearRect(0,0,e.screenWidth,e.screenHeight),r.textBaseline="normal",r.globalAlpha=.5,r.fillStyle="black",r.fillRect(0,0,e.screenWidth,e.screenHeight),r.clearRect(e.cropX,e.cropY,e.cropWidth,e.cropHeight),r.beginPath(),r.strokeStyle="white",r.strokeRect(e.cropX,e.cropY,e.cropWidth,e.cropHeight),r.closePath(),r.draw()}})},drawImage:function(e){var i=this;t.getImageInfo({src:e,success:function(t){if(i.imgWidth=t.width,i.imgHeight=t.height,i.imgWidth>=i.imgHeight)if(i.imgWidth>=i.screenWidth){var e=i.imgWidth/i.screenWidth;i.imgWidth=i.screenWidth,i.imgHeight=Math.ceil(i.imgHeight/e),i.imgX=0,i.imgY=(i.screenHeight-i.imgHeight)/2}else i.imgX=(i.screenWidth-i.imgWidth)/2,i.imgY=(i.screenHeight-i.imgHeight)/2;else if(i.imgHeight>=i.screenHeight){var r=i.imgHeight/i.screenHeight;i.imgHeight=i.screenHeight,i.imgWidth=Math.ceil(i.imgWidth/r),i.imgX=(i.screenWidth-i.imgWidth)/2,i.imgY=0}else i.imgX=(i.screenWidth-i.imgWidth)/2,i.imgY=(i.screenHeight-i.imgHeight)/2;i.ctx.drawImage(t.path,i.imgX,i.imgY,i.imgWidth*i.currentNumber,i.imgHeight*i.currentNumber),i.ctx.draw()}})},handleTouchStart:function(t){this.isMoving||(this.startX=t.touches[0].pageX,this.startY=t.touches[0].pageY,this.isMoving=!0)},handleTouchMove:function(t){if(this.isMoving){var e=t.touches[0].pageX-this.startX,i=t.touches[0].pageY-this.startY;this.imgX+=e,this.imgY+=i,this.startX=t.touches[0].pageX,this.startY=t.touches[0].pageY,this.imgX>=this.cropX&&(this.imgX=this.cropX),this.imgY>=this.cropY&&(this.imgY=this.cropY),this.imgX<=this.cropWidth+this.cropX-this.imgWidth*this.currentNumber&&(this.imgX=this.cropWidth+this.cropX-this.imgWidth*this.currentNumber),this.imgY<=this.cropHeight+this.cropY-this.imgHeight*this.currentNumber&&(this.imgY=this.cropHeight+this.cropY-this.imgHeight*this.currentNumber),this.ctx.drawImage(this.imgUrl,this.imgX,this.imgY,this.imgWidth*this.currentNumber,this.imgHeight*this.currentNumber),this.ctx.draw()}},handleTouchEnd:function(){this.isMoving=!1}},onUnload:function(){this.rewardAd.destroyAllAd()}};e.default=m}).call(this,i("4884")["default"])},c6ea:function(t,e,i){"use strict";var r=i("8b7d"),n=i.n(r);n.a},ef87:function(t,e,i){"use strict";(function(t,e){var r=i("47a9");i("2088");r(i("3240"));var n=r(i("849a"));t.__webpack_require_UNI_MP_PLUGIN__=i,e(n.default)}).call(this,i("4884")["default"],i("4884")["createPage"])}},[["ef87","common/runtime","common/vendor"]]]);